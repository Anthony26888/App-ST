(function(i,Q){typeof exports=="object"&&typeof module<"u"?Q(exports):typeof define=="function"&&define.amd?define(["exports"],Q):(i=typeof globalThis<"u"?globalThis:i||self,Q(i.TracespaceParser={}))})(this,function(i){"use strict";var Q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},me={},St={get exports(){return me},set exports(e){me=e}};(function(e){(function(o,r){e.exports?e.exports=r():o.moo=r()})(Q,function(){var o=Object.prototype.hasOwnProperty,r=Object.prototype.toString,s=typeof new RegExp().sticky=="boolean";function l(n){return n&&r.call(n)==="[object RegExp]"}function u(n){return n&&typeof n=="object"&&!l(n)&&!Array.isArray(n)}function d(n){return n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function h(n){var a=new RegExp("|"+n);return a.exec("").length-1}function L(n){return"("+n+")"}function y(n){if(!n.length)return"(?!)";var a=n.map(function(c){return"(?:"+c+")"}).join("|");return"(?:"+a+")"}function C(n){if(typeof n=="string")return"(?:"+d(n)+")";if(l(n)){if(n.ignoreCase)throw new Error("RegExp /i flag not allowed");if(n.global)throw new Error("RegExp /g flag is implied");if(n.sticky)throw new Error("RegExp /y flag is implied");if(n.multiline)throw new Error("RegExp /m flag is implied");return n.source}else throw new Error("Not a pattern: "+n)}function U(n,a){return n.length>a?n:Array(a-n.length+1).join(" ")+n}function _n(n,a){for(var c=n.length,f=0;;){var R=n.lastIndexOf(`
`,c-1);if(R===-1||(f++,c=R,f===a)||c===0)break}var E=f<a?0:c+1;return n.substring(E).split(`
`)}function Nn(n){for(var a=Object.getOwnPropertyNames(n),c=[],f=0;f<a.length;f++){var R=a[f],E=n[R],m=[].concat(E);if(R==="include"){for(var M=0;M<m.length;M++)c.push({include:m[M]});continue}var O=[];m.forEach(function(p){u(p)?(O.length&&c.push(te(R,O)),c.push(te(R,p)),O=[]):O.push(p)}),O.length&&c.push(te(R,O))}return c}function Ln(n){for(var a=[],c=0;c<n.length;c++){var f=n[c];if(f.include){for(var R=[].concat(f.include),E=0;E<R.length;E++)a.push({include:R[E]});continue}if(!f.type)throw new Error("Rule has no type: "+JSON.stringify(f));a.push(te(f.type,f))}return a}function te(n,a){if(u(a)||(a={match:a}),a.include)throw new Error("Matching rules cannot also include states");var c={defaultType:n,lineBreaks:!!a.error||!!a.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var f in a)o.call(a,f)&&(c[f]=a[f]);if(typeof c.type=="string"&&n!==c.type)throw new Error("Type transform cannot be a string (type '"+c.type+"' for token '"+n+"')");var R=c.match;return c.match=Array.isArray(R)?R:R?[R]:[],c.match.sort(function(E,m){return l(E)&&l(m)?0:l(m)?-1:l(E)?1:m.length-E.length}),c}function Be(n){return Array.isArray(n)?Ln(n):Nn(n)}var gn=te("error",{lineBreaks:!0,shouldThrow:!0});function gt(n,a){for(var c=null,f=Object.create(null),R=!0,E=null,m=[],M=[],O=0;O<n.length;O++)n[O].fallback&&(R=!1);for(var O=0;O<n.length;O++){var p=n[O];if(p.include)throw new Error("Inheritance is not allowed in stateless lexers");if(p.error||p.fallback){if(c)throw!p.fallback==!c.fallback?new Error("Multiple "+(p.fallback?"fallback":"error")+" rules not allowed (for token '"+p.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+p.defaultType+"')");c=p}var I=p.match.slice();if(R)for(;I.length&&typeof I[0]=="string"&&I[0].length===1;){var W=I.shift();f[W.charCodeAt(0)]=p}if(p.pop||p.push||p.next){if(!a)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+p.defaultType+"')");if(p.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+p.defaultType+"')")}if(I.length!==0){R=!1,m.push(p);for(var z=0;z<I.length;z++){var $=I[z];if(l($)){if(E===null)E=$.unicode;else if(E!==$.unicode&&p.fallback===!1)throw new Error("If one rule is /u then all must be")}}var X=y(I.map(C)),P=new RegExp(X);if(P.test(""))throw new Error("RegExp matches empty string: "+P);var ne=h(X);if(ne>0)throw new Error("RegExp has capture groups: "+P+`
Use (?: â€¦ ) instead`);if(!p.lineBreaks&&P.test(`
`))throw new Error("Rule should declare lineBreaks: "+P);M.push(L(X))}}var K=c&&c.fallback,re=s&&!K?"ym":"gm",Re=s||K?"":"|";E===!0&&(re+="u");var bn=new RegExp(y(M)+Re,re);return{regexp:bn,groups:m,fast:f,error:c||gn}}function In(n){var a=gt(Be(n));return new S({start:a},"start")}function It(n,a,c){var f=n&&(n.push||n.next);if(f&&!c[f])throw new Error("Missing state '"+f+"' (in token '"+n.defaultType+"' of state '"+a+"')");if(n&&n.pop&&+n.pop!=1)throw new Error("pop must be 1 (in token '"+n.defaultType+"' of state '"+a+"')")}function Sn(n,a){var c=n.$all?Be(n.$all):[];delete n.$all;var f=Object.getOwnPropertyNames(n);a||(a=f[0]);for(var R=Object.create(null),E=0;E<f.length;E++){var m=f[E];R[m]=Be(n[m]).concat(c)}for(var E=0;E<f.length;E++)for(var m=f[E],M=R[m],O=Object.create(null),p=0;p<M.length;p++){var I=M[p];if(I.include){var W=[p,1];if(I.include!==m&&!O[I.include]){O[I.include]=!0;var z=R[I.include];if(!z)throw new Error("Cannot include nonexistent state '"+I.include+"' (in state '"+m+"')");for(var $=0;$<z.length;$++){var X=z[$];M.indexOf(X)===-1&&W.push(X)}}M.splice.apply(M,W),p--}}for(var P=Object.create(null),E=0;E<f.length;E++){var m=f[E];P[m]=gt(R[m],!0)}for(var E=0;E<f.length;E++){for(var ne=f[E],K=P[ne],re=K.groups,p=0;p<re.length;p++)It(re[p],ne,P);for(var Re=Object.getOwnPropertyNames(K.fast),p=0;p<Re.length;p++)It(K.fast[Re[p]],ne,P)}return new S(P,a)}function wn(n){for(var a=typeof Map<"u",c=a?new Map:Object.create(null),f=Object.getOwnPropertyNames(n),R=0;R<f.length;R++){var E=f[R],m=n[E],M=Array.isArray(m)?m:[m];M.forEach(function(O){if(typeof O!="string")throw new Error("keyword must be string (in keyword '"+E+"')");a?c.set(O,E):c[O]=E})}return function(O){return a?c.get(O):c[O]}}var S=function(n,a){this.startState=a,this.states=n,this.buffer="",this.stack=[],this.reset()};S.prototype.reset=function(n,a){return this.buffer=n||"",this.index=0,this.line=a?a.line:1,this.col=a?a.col:1,this.queuedToken=a?a.queuedToken:null,this.queuedText=a?a.queuedText:"",this.queuedThrow=a?a.queuedThrow:null,this.setState(a?a.state:this.startState),this.stack=a&&a.stack?a.stack.slice():[],this},S.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},S.prototype.setState=function(n){if(!(!n||this.state===n)){this.state=n;var a=this.states[n];this.groups=a.groups,this.error=a.error,this.re=a.regexp,this.fast=a.fast}},S.prototype.popState=function(){this.setState(this.stack.pop())},S.prototype.pushState=function(n){this.stack.push(this.state),this.setState(n)};var Dn=s?function(n,a){return n.exec(a)}:function(n,a){var c=n.exec(a);return c[0].length===0?null:c};S.prototype._getGroup=function(n){for(var a=this.groups.length,c=0;c<a;c++)if(n[c+1]!==void 0)return this.groups[c];throw new Error("Cannot find token type for matched text")};function Pn(){return this.value}if(S.prototype.next=function(){var n=this.index;if(this.queuedGroup){var a=this._token(this.queuedGroup,this.queuedText,n);return this.queuedGroup=null,this.queuedText="",a}var c=this.buffer;if(n!==c.length){var m=this.fast[c.charCodeAt(n)];if(m)return this._token(m,c.charAt(n),n);var f=this.re;f.lastIndex=n;var R=Dn(f,c),E=this.error;if(R==null)return this._token(E,c.slice(n,c.length),n);var m=this._getGroup(R),M=R[0];return E.fallback&&R.index!==n?(this.queuedGroup=m,this.queuedText=M,this._token(E,c.slice(n,R.index),n)):this._token(m,M,n)}},S.prototype._token=function(n,a,c){var f=0;if(n.lineBreaks){var R=/\n/g,E=1;if(a===`
`)f=1;else for(;R.exec(a);)f++,E=R.lastIndex}var m={type:typeof n.type=="function"&&n.type(a)||n.defaultType,value:typeof n.value=="function"?n.value(a):a,text:a,toString:Pn,offset:c,lineBreaks:f,line:this.line,col:this.col},M=a.length;if(this.index+=M,this.line+=f,f!==0?this.col=M-E+1:this.col+=M,n.shouldThrow){var O=new Error(this.formatError(m,"invalid syntax"));throw O}return n.pop?this.popState():n.push?this.pushState(n.push):n.next&&this.setState(n.next),m},typeof Symbol<"u"&&Symbol.iterator){var Ue=function(n){this.lexer=n};Ue.prototype.next=function(){var n=this.lexer.next();return{value:n,done:!n}},Ue.prototype[Symbol.iterator]=function(){return this},S.prototype[Symbol.iterator]=function(){return new Ue(this)}}return S.prototype.formatError=function(n,a){if(n==null)var c=this.buffer.slice(this.index),n={text:c,offset:this.index,lineBreaks:c.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var f=2,R=Math.max(n.line-f,1),E=n.line+f,m=String(E).length,M=_n(this.buffer,this.line-n.line+f+1).slice(0,5),O=[];O.push(a+" at line "+n.line+" col "+n.col+":"),O.push("");for(var p=0;p<M.length;p++){var I=M[p],W=R+p;O.push(U(String(W),m)+"  "+I),W===n.line&&O.push(U("",m+n.col+1)+"^")}return O.join(`
`)},S.prototype.clone=function(){return new S(this.states,this.state)},S.prototype.has=function(n){return!0},{compile:In,states:Sn,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:wn}})})(St);const He=me,Z="T_CODE",v="G_CODE",G="M_CODE",w="D_CODE",A="ASTERISK",g="PERCENT",Oe="EQUALS",F="COMMA",H="OPERATOR",oe="GERBER_FORMAT",J="GERBER_UNITS",ve="GERBER_TOOL_MACRO",Te="GERBER_TOOL_DEF",Ae="GERBER_LOAD_POLARITY",ye="GERBER_STEP_REPEAT",Y="GERBER_MACRO_VARIABLE",Ce="SEMICOLON",Me="DRILL_UNITS",ie="DRILL_ZERO_INCLUSION",_="COORD_CHAR",N="NUMBER",qe="WORD",Fe="WHITESPACE",D="NEWLINE",Ve="CATCHALL",ke="ERROR",wt=/^0*/,xe=e=>e.replace(wt,""),ae=e=>xe(e.slice(1))||"0",Dt={[Z]:{match:/T\d+/,value:ae},[v]:{match:/G\d+/,value:ae},[G]:{match:/M\d+/,value:ae},[w]:{match:/D\d+/,value:ae},[A]:"*",[g]:"%",[Oe]:"=",[oe]:{match:/FS[LTDAI]+/,value:e=>e.slice(2)},[J]:{match:/MO(?:IN|MM)/,value:e=>e.slice(2)},[ve]:{match:/AM[a-zA-Z_.$][\w.-]*/,value:e=>e.slice(2)},[Te]:{match:/ADD\d+[a-zA-Z_.$][\w.-]*/,value:e=>xe(e.slice(3))},[Ae]:{match:/LP[DC]/,value:e=>e.slice(2)},[ye]:"SR",[Y]:/\$\d+/,[Ce]:";",[Me]:/^(?:METRIC|INCH)/,[ie]:{match:/,(?:TZ|LZ)/,value:e=>e.slice(1)},[_]:/[XYIJACFSBHZN]/,[N]:/[+-]?[\d.]+/,[H]:["x","/","+","-","(",")"],[F]:",",[qe]:/[a-zA-Z]+/,[Fe]:/[ \t]+/,[D]:{match:/\r?\n/,lineBreaks:!0},[Ve]:/\S/,[ke]:He.error};function We(){const e=He.compile(Dt);return{feed:o};function o(s,l=null){return e.reset(s,l??void 0),r((l==null?void 0:l.offset)??0)}function r(s){return{[Symbol.iterator](){return this},next(){const l=e.next();if(l){const u={...l,offset:s+l.offset},d={...e.save(),offset:s+(e.index??0)};return{value:[u,d]}}return{value:void 0,done:!0}}}}}const _e="gerber",le="drill",se="mm",ce="in",Ne="leading",Le="trailing",ze="absolute",$e="incremental",ue="circle",ge="rectangle",Ze="obround",Ye="polygon",Xe="macroShape",Pt="1",bt="2",Gt="20",Bt="21",Ut="22",Ht="4",qt="5",Ft="6",Vt="7",Ke="shape",Ie="move",Qe="segment",Je="slot",je="line",et="cwArc",tt="ccwArc",nt="single",rt="multi",ot="dark",it="clear",fe="TOKEN",q="MIN_TO_MAX";function t(e,o){return{rule:fe,type:e,value:o}}function V(e,o){return{rule:fe,type:e,value:o,negate:!0}}function B(e){return{rule:q,min:1,max:1,match:e}}function j(e){return{rule:q,min:0,max:1,match:e}}function b(e){return{rule:q,min:0,max:Number.POSITIVE_INFINITY,match:e}}function at(e){return{rule:q,min:1,max:Number.POSITIVE_INFINITY,match:e}}function k(e,o,r){return{rule:q,min:e,max:o,match:r}}function lt(e,o){const r=[];for(const s of o){const l=xt(e,s.rules);if(l===ct)r.push(s);else if(l===st)return{filetype:s.filetype,nodes:s.createNodes(e)}}return r.length>0?{candidates:r,tokens:e}:{}}const st="FULL_MATCH",ct="PARTIAL_MATCH",kt="NO_MATCH";function xt(e,o){let r=0,s=0,l=0;for(;r<o.length&&s<e.length;){const u=o[r],d=e[s];if(ut(u,d))u.rule===fe||u.rule===q&&l>=u.max-1?(r++,s++,l=0):u.rule===q&&(s++,l++);else if(u.rule===q&&l>=u.min)l=0,r++;else return kt}return r<o.length?ct:st}function ut(e,o){if(e.rule===fe){const r=e.type===o.type,s=e.value===null||typeof e.value>"u"||typeof e.value=="string"&&e.value===o.value||e.value instanceof RegExp&&e.value.test(o.value),l=r&&s;return e.negate?!l:l}return Array.isArray(e.match)?e.match.some(r=>ut(r,o)):!1}const ft="root",Se="comment",dt="drillHeader",we="done",de="units",De="coordinateFormat",Pe="toolDefinition",ht="toolMacro",he="toolChange",Et="loadPolarity",pt="stepRepeat",Ee="graphic",ee="interpolateMode",Rt="regionMode",mt="quadrantMode",Ot="unimplemented",vt="macroComment",Tt="macroVariable",At="macroPrimitive";function x(e){return Object.fromEntries(e.map((o,r)=>[o,e[r-1]]).filter(([o,r])=>o.type===N&&(r==null?void 0:r.type)===_).map(([o,r])=>[r.value.toLowerCase(),o.value]))}function pe(e){return e.filter(r=>r.type===v).map(r=>r.value==="0"?Ie:r.value==="1"?je:r.value==="2"?et:r.value==="3"?tt:r.value==="5"?le:null)[0]??null}function Wt(e){return e.filter(r=>r.type===w).map(r=>r.value==="1"?Qe:r.value==="2"?Ie:r.value==="3"?Ke:null)[0]??null}function be(e){return e.map(o=>o.value).join("").trim()}function T(e,o={}){const{head:r=e[0],length:s=0}=o,l=s>0?e[e.indexOf(r)+s-1]:e[e.length-1];return{start:{line:r.line,column:r.col,offset:r.offset},end:{line:l.line,column:l.col,offset:l.offset}}}const zt={name:"units",rules:[B([t(Me),t(G,"71"),t(G,"72")]),b([t(F),t(ie),t(N,/^0{1,8}\.0{1,8}$/)]),t(D)],createNodes(e){const o=e[0].value==="INCH"||e[0].value==="72"?ce:se,r=e.filter(u=>u.type===ie).map(u=>u.value==="LZ"?Le:u.value==="TZ"?Ne:null),s=e.filter(u=>u.type===N).map(u=>{const[d="",h=""]=u.value.split(".");return[d.length,h.length]}),l=[{type:de,position:T(e.slice(0,2)),units:o}];return(r.length>0||s.length>0)&&l.push({type:De,position:T(e.slice(1)),mode:null,format:s[0]??null,zeroSuppression:r[0]??null}),l}},$t={name:"tool",rules:[t(Z),k(0,12,[t(_,"C"),t(_,"F"),t(_,"S"),t(_,"B"),t(_,"H"),t(_,"Z"),t(N)]),t(D)],createNodes(e){const o=e[0].value,r=T(e),{c:s=null}=x(e.slice(1,-1)),l=s===null?null:{type:ue,diameter:Number(s)};return l?[{type:Pe,hole:null,position:r,shape:l,code:o}]:[{type:he,position:r,code:o}]}},Zt={name:"operationMode",rules:[B([t(v,"0"),t(v,"1"),t(v,"2"),t(v,"3"),t(v,"5")]),t(D)],createNodes:e=>[{type:ee,position:T(e),mode:pe(e)}]},Yt={name:"operation",rules:[k(0,2,[t(Z),t(v,"0"),t(v,"1"),t(v,"2"),t(v,"3"),t(v,"5")]),k(2,8,[t(_),t(N)]),j([t(Z)]),t(D)],createNodes(e){const o=e.filter(U=>U.type===_||U.type===N),r=e.find(U=>U.type===v),s=e.find(U=>U.type===Z),l=x(o),u=s?s.value:null,d=pe(e),h=T(e,{head:o[0],length:o.length+1}),L=T(e,{head:r,length:2}),y=T(e,{head:s,length:2}),C=[{type:Ee,position:h,graphic:null,coordinates:l}];return d&&C.unshift({type:ee,position:L,mode:d}),u&&C.unshift({type:he,position:y,code:u}),C}},Xt={name:"slot",rules:[k(2,4,[t(_),t(N)]),t(v,"85"),k(2,4,[t(_),t(N)]),t(D)],createNodes(e){const o=e.find(u=>u.type===v),r=o?e.indexOf(o):-1,s=Object.fromEntries(Object.entries(x(e.slice(0,r))).map(([u,d])=>[`${u}0`,d])),l=x(e.slice(r));return[{type:Ee,position:T(e),graphic:Je,coordinates:{...s,...l}}]}},Kt={name:"done",rules:[B([t(G,"30"),t(G,"0")]),t(D)],createNodes:e=>[{type:we,position:T(e)}]},Qt={name:"header",rules:[B([t(G,"48"),t(g)]),t(D)],createNodes:e=>[{type:dt,position:T(e)}]},Jt={name:"comment",rules:[t(Ce),b([V(D)]),t(D)],createNodes:e=>[{type:Se,comment:be(e.slice(1,-1)),position:T(e)}]},yt=[$t,Zt,Yt,Xt,Jt,zt,Kt,Qt].map(e=>({...e,filetype:le})),jt={name:"macroComment",rules:[t(N,"0"),b([V(A)]),t(A)],createNodes:nn},en={name:"macroVariable",rules:[t(Y),t(Oe),at([t(N),t(H),t(Y),t(_,"X")]),t(A)],createNodes:on},tn={name:"macroPrimitive",rules:[t(N),t(F),at([t(F),t(N),t(H),t(Y),t(_,"X")]),t(A)],createNodes:rn};function nn(e){const o=e.slice(1,-1).map(r=>r.text).join("").trim();return[{type:vt,position:T(e),comment:o}]}function rn(e){const o=e[0].value,r=[[]];let s=r[0];for(const u of e.slice(2,-1))u.type===F?(s=[],r.push(s)):s.push(u);const l=r.map(u=>Ct(u));return[{type:At,position:T(e),code:o,parameters:l}]}function on(e){const o=e[0].value,r=Ct(e.slice(2,-1));return[{type:Tt,position:T(e),name:o,value:r}]}function Ct(e){const o=e.map(d=>d.type===_?{...d,type:H,value:"x"}:d);return u();function r(){return o[0]??null}function s(){const d=o.shift();if(d.type===N)return Number(d.value);if(d.type===Y)return d.value;const h=u();return o.shift(),h}function l(){let d=s(),h=r();for(;(h==null?void 0:h.type)===H&&(h.value==="x"||h.value==="/");)o.shift(),d={left:d,right:s(),operator:h.value},h=r();return d}function u(){let d=l(),h=r();for(;(h==null?void 0:h.type)===H&&(h.value==="+"||h.value==="-")||(h==null?void 0:h.type)===N;){let L="+";h.type===H&&(o.shift(),L=h.value);const y=l();d={left:d,right:y,operator:L},h=r()}return d}}const Mt=[tn,en,jt];function an(e){let o=Mt,r=[];const s=[];for(const l of e){const u=lt([...r,l],o);u.nodes&&s.push(...u.nodes),r=u.tokens??[],o=u.candidates??Mt}return s}const Ge=e=>{if(e.length===1){const[o]=e;return{type:ue,diameter:o}}if(e.length===2){const[o,r]=e;return{type:ge,xSize:o,ySize:r}}return null},ln={name:"done",rules:[B([t(G,"0"),t(G,"2")]),t(A)],createNodes:e=>[{type:we,position:T(e)}]},sn={name:"comment",rules:[t(v,"4"),b([V(A)]),t(A)],createNodes:e=>[{type:Se,position:T(e),comment:be(e.slice(1,-1))}]},cn={name:"format",rules:[t(g),t(oe),b([V(_,"X")]),t(_,"X"),t(N),t(_,"Y"),t(N),b([V(A)]),t(A),k(0,2,[t(J),t(A)]),t(g)],createNodes(e){var L;let o=null,r=null,s=null;const l=x(e),u=e.findIndex(y=>y.type===A),d=e.find(y=>y.type===J);for(const y of e.filter(C=>C.type===oe))y.value.includes("T")&&(r=Le),y.value.includes("L")&&(r=Ne),y.value.includes("I")&&(s=$e),y.value.includes("A")&&(s=ze);if(l.x===l.y&&((L=l.x)==null?void 0:L.length)===2){const y=Number(l.x[0]),C=Number(l.x[1]);y&&C&&(o=[y,C])}const h=[{type:De,position:T(e.slice(1,u+1)),zeroSuppression:r,format:o,mode:s}];return d&&h.push({type:de,position:T(e.slice(1,-1),{head:d}),units:d.value==="MM"?se:ce}),h}},un={name:"units",rules:[t(g),t(J),t(A),t(g)],createNodes:e=>[{type:de,position:T(e.slice(1,-1)),units:e[1].value==="MM"?se:ce}]},fn={name:"toolMacro",rules:[t(g),t(ve),t(A),b([V(g)]),t(g)],createNodes(e){const o=e[1].value,r=T(e.slice(1,-1)),s=e.slice(3,-1);return[{type:ht,position:r,children:an(s),name:o}]}},dn={name:"toolDefinition",rules:[t(g),t(Te),b([t(F),t(N),t(_,"X")]),t(A),t(g)],createNodes(e){let o,r=null;const s=/(\d+)(.+)/.exec(e[1].value),[,l="",u=""]=s??[],d=e.slice(3,-2).filter(h=>h.type===N).map(h=>Number(h.value));switch(u){case"C":{const[h,...L]=d;o={type:ue,diameter:h},r=Ge(L);break}case"R":case"O":{const[h,L,...y]=d;o={type:u==="R"?ge:Ze,xSize:h,ySize:L},r=Ge(y);break}case"P":{const[h,L,y=null,...C]=d;o={type:Ye,diameter:h,vertices:L,rotation:y},r=Ge(C);break}default:o={type:Xe,name:u,variableValues:d}}return[{type:Pe,position:T(e.slice(1,-1)),code:l,shape:o,hole:r}]}},hn={name:"toolChange",rules:[j([t(v,"54")]),t(w),t(A)],createNodes:e=>[{type:he,position:T(e),code:e.find(o=>o.type===w).value}]},_t=e=>{const o=Wt(e),r=x(e),s=pe(e),l=T(e,{head:s?e[1]:e[0]}),u=[{type:Ee,position:l,graphic:o,coordinates:r}];if(s){const d=T(e,{head:e[0],length:2});u.unshift({type:ee,position:d,mode:s})}return u},En={name:"operation",rules:[j([t(v,"1"),t(v,"2"),t(v,"3")]),k(2,8,[t(_),t(N)]),j([t(w,"1"),t(w,"2"),t(w,"3")]),t(A)],createNodes:_t},pn={name:"operationWithoutCoords",rules:[j([t(v,"1"),t(v,"2"),t(v,"3")]),B([t(w,"1"),t(w,"2"),t(w,"3")]),t(A)],createNodes:_t},Rn={name:"interpolationMode",rules:[B([t(v,"1"),t(v,"2"),t(v,"3")]),t(A)],createNodes:e=>[{type:ee,position:T(e),mode:pe(e)}]},mn={name:"regionMode",rules:[B([t(v,"36"),t(v,"37")]),t(A)],createNodes:e=>[{type:Rt,position:T(e),region:e[0].value==="36"}]},On={name:"quadrantMode",rules:[B([t(v,"74"),t(v,"75")]),t(A)],createNodes:e=>[{type:mt,position:T(e),quadrant:e[0].value==="74"?nt:rt}]},vn={name:"loadPolarity",rules:[t(g),t(Ae),t(A),t(g)],createNodes:e=>[{type:Et,position:T(e.slice(1,-1)),polarity:e[1].value==="D"?ot:it}]},Tn={name:"stepRepeat",rules:[t(g),t(ye),b([t(_),t(N)]),t(A),t(g)],createNodes(e){const o=x(e),r=Object.fromEntries(Object.entries(o).map(([s,l])=>[s,Number(l)]));return[{type:pt,position:T(e.slice(1,-1)),stepRepeat:r}]}},An={name:"unimplementedExtendedCommand",rules:[t(g),b([V(A)]),t(A),t(g)],createNodes:e=>[{type:Ot,position:T(e.slice(1,-1)),value:be(e)}]},Nt=[En,pn,Rn,hn,dn,fn,sn,mn,On,vn,Tn,cn,un,ln,An].map(e=>({...e,filetype:_e})),yn=[...Nt,...yt];function Cn(e,o=null){const r=[];let s=h(),l=[],u=null,d="";for(const[L,y]of e){const C=lt([...l,L],s);C.nodes?(r.push(...C.nodes),u=y,d=""):d+=L.text,o=o??C.filetype??null,l=C.tokens??[],s=C.candidates??h()}return{filetype:o,unmatched:d,nodes:r,lexerState:u};function h(){return o===_e?Nt:o===le?yt:yn}}function Lt(){const e=We(),o=[];let r=null,s=null,l="";const u={lexer:e,feed:d,result:h};return u;function d(L){const y=e.feed(`${l}${L}`,s),C=Cn(y,r);return r=r??C.filetype,l=C.unmatched,s=C.lexerState??s,o.push(...C.nodes),u}function h(){if(r===null)throw new Error("File type not recognized");return{type:ft,filetype:r,children:o}}}function Mn(e){return Lt().feed(e).result()}i.ABSOLUTE=ze,i.ASTERISK=A,i.CATCHALL=Ve,i.CCW_ARC=tt,i.CIRCLE=ue,i.CLEAR=it,i.COMMA=F,i.COMMENT=Se,i.COORDINATE_FORMAT=De,i.COORD_CHAR=_,i.CW_ARC=et,i.DARK=ot,i.DONE=we,i.DRILL=le,i.DRILL_HEADER=dt,i.DRILL_UNITS=Me,i.DRILL_ZERO_INCLUSION=ie,i.D_CODE=w,i.EQUALS=Oe,i.ERROR=ke,i.GERBER=_e,i.GERBER_FORMAT=oe,i.GERBER_LOAD_POLARITY=Ae,i.GERBER_MACRO_VARIABLE=Y,i.GERBER_STEP_REPEAT=ye,i.GERBER_TOOL_DEF=Te,i.GERBER_TOOL_MACRO=ve,i.GERBER_UNITS=J,i.GRAPHIC=Ee,i.G_CODE=v,i.IN=ce,i.INCREMENTAL=$e,i.INTERPOLATE_MODE=ee,i.LEADING=Ne,i.LINE=je,i.LOAD_POLARITY=Et,i.MACRO_CENTER_LINE=Bt,i.MACRO_CIRCLE=Pt,i.MACRO_COMMENT=vt,i.MACRO_LOWER_LEFT_LINE_DEPRECATED=Ut,i.MACRO_MOIRE_DEPRECATED=Ft,i.MACRO_OUTLINE=Ht,i.MACRO_POLYGON=qt,i.MACRO_PRIMITIVE=At,i.MACRO_SHAPE=Xe,i.MACRO_THERMAL=Vt,i.MACRO_VARIABLE=Tt,i.MACRO_VECTOR_LINE=Gt,i.MACRO_VECTOR_LINE_DEPRECATED=bt,i.MM=se,i.MOVE=Ie,i.MULTI=rt,i.M_CODE=G,i.NEWLINE=D,i.NUMBER=N,i.OBROUND=Ze,i.OPERATOR=H,i.PERCENT=g,i.POLYGON=Ye,i.QUADRANT_MODE=mt,i.RECTANGLE=ge,i.REGION_MODE=Rt,i.ROOT=ft,i.SEGMENT=Qe,i.SEMICOLON=Ce,i.SHAPE=Ke,i.SINGLE=nt,i.SLOT=Je,i.STEP_REPEAT=pt,i.TOOL_CHANGE=he,i.TOOL_DEFINITION=Pe,i.TOOL_MACRO=ht,i.TRAILING=Le,i.T_CODE=Z,i.UNIMPLEMENTED=Ot,i.UNITS=de,i.WHITESPACE=Fe,i.WORD=qe,i.createLexer=We,i.createParser=Lt,i.parse=Mn,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=tracespace-parser.umd.cjs.map
